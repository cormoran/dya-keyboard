# <img src="../../../../img/dya.svg" width=32> DYA v1.0 ビルドガイド

https://cormoran707.booth.pm/ で配布予定のキット向けのビルドガイドです。

## 別途購入が必要な部品

- MX 互換キースイッチ
  - US 配列にする場合 x69
  - JIS 配列にする場合 x71
- キーキャップ
  - US, JIS 両方で必要なキーキャップがすべて揃っている [acid-caps](https://keeb-on.com/collections/acid-caps) がおすすめです
  - 以下の３点が通常の配列と異なります。下で画像付きで説明しています。
    - "6", "Y", "B" が左右２つ必要
    - US 配列では 2.75U、JIS 配列では 1.5U のスペースキー
    - R1(最下列)に４つ、R2 (一つ上の列)に１〜２つの 1U キー
- スタビライザー 2U x4 (US) or x3 (JIS)
  - なしでも動作はします
- **34mm** トラックボール用ボール
  - 色は自由ですが、色によって反応が悪くなる場合があります
- RP2040-zero x2
- **高さ 3.5mm の**コンスルー 46pin (左右 23pin ずつ) 分
  - このガイドでは [12pin のコンスルー](https://www.switch-science.com/products/7448?variant=42382161215686)４つを分割して使用します
- USB ケーブル
  - Type C to C ケーブル（左右接続用）x1
  - Type C ケーブル（PC 接続用）x1
  - 通信用ケーブルが必要です。充電専用ケーブルでは動作しないので注意してください
- 適当なテープ
  - FFC ケーブルをケースに固定するために使います

### 必要なキーキャップサイズ

以下の例では、斜めになった親指キー部分には Tecsee Pudding Medium Linear Switch と Tai-Hao Thins low profile keycap を使用して高さを抑えています。
また、一部のスペースキーはキーキャップを上下逆にすることで親指に角が当たらないようにしています。

#### US 配列

![US](../us-keycap-size.jpg)

#### JIS 配列

![JIS](../jis-keycap-size.jpg)

## 必要な工具

- はんだ、はんだごて
  - RP2040-zero と、PMW3610 ははんだ付けが必要です
- ニッパー
- プラスドライバー（M2 ネジ用）

## キットに含まれる部品

- 回路基板(左、右、トラックボール基板が接続されたもの、厚み 1.6mm)
- トッププレート（左、右が接続されたもの、厚み 1.2mm）
- PMW3610 センサー IC とレンズ
- 3D プリント製ケース（左上下、右上下、34mm トラックボールホルダー）
- M2 ねじ 5mmx16 (ケース上下接続用)
- M2 ねじ 4mmx2 (トラックボールケース接続用)
- 6pin FFC ケーブル (トラックボール基板接続用)
- ゴム足 x8

| PCB, トッププレート  | ケースなど                |
| -------------------- | ------------------------- |
| ![](./img/1_pcb.jpg) | ![](./img/1_case_etc.jpg) |

## 注意点

- FFC ケーブルの面裏、配線に注意
- ネジを強く締めすぎない
- 使用時は RP2040-zero のコンスルーが外れてしまわないように注意

## 手順

### 1. 基板の切り離し

以下の２つの基板を切り離します

![](./img/1_pcb.jpg)

小さなドリル穴で接続されている部分をニッパーなどで切断してください。

#### 1.1 回路基板

以下のように３つの基板に分かれます。

基板どうしを接続していた切れ端は使わないので捨ててください

切り取った部分にバリが目立つ場合はニッパーやヤスリで平らにするとケースとの干渉が防げます。

配線部分を傷つけないように注意してください。

![](./img/2_pcb_bottom.jpg)

#### 1.2 トッププレート

トッププレートも同様に分離してください。
トッププレートは薄い部分があるので、接続部以外が破損しないように注意してください。

![](./img/2_pcb_top.jpg)

### 2. はんだ付け

#### 2.1 PMW3610

キット同梱の以下の３つのパーツを用意してください

![](./img/3_1_trackball.jpg)

IC を以下のような方向で基板にはんだ付けします。
IC が基板に対して平行になるようにしてください。半田付け前にレンズがセットできるか確認することをお勧めします。
レンズは熱で溶けるので、**半田付けはレンズを外した状態で**行ってください。

|                              |                               |                               |
| ---------------------------- | ----------------------------- | ----------------------------- |
| ![](./img/3_2_trackball.jpg) | ![](./img/3_2_trackball2.jpg) | ![](./img/3_2_trackball3.jpg) |

以下のように端のピンをまずはんだ付けすると IC が固定されて作業しやすくなります。

長時間はんだごてを当てると IC が破損する可能性があるので注意してください。

![](./img/3_3_trackball.jpg)

IC を取り付けたら、IC についていた透明な保護フィルムを剥がしてレンズをセットします

![](./img/3_4_trackball.jpg)

![](./img/3_5_trackball.jpg)

最後に IC の表側に出っ張っているレンズの足を処理します。

このままではケースと干渉するので、出っ張りをニッパーで切断するか、ハンダゴテで熱を加えて潰すように溶かしてください。
レンズが外れないように溶かすのが推奨されている方法のようですが、作者はニッパーで切断しています。

![](./img/3_5_trackball2.jpg)

#### 2.2 RP2040-zero

別途購入した RP2040-zero にコンスルーを取り付けます。以下の手順で２つの RP2040-zero を作ってください。まず一つ作ってファームウェアの書き込みとキーボードの動作確認までしてから、２つ目を作ると良いかもしれません。

1. 12pin コンスルー x2 を切断して 9pin x2, 3 pin x1, 2pin x1 を作ります。残った 1pin は使用しません。
2. 以下の画像のように RP2040-zero にとりつけて、**RP2040 側のみを**半田付けします。コンスルーには上下左右があるのでネットで検索して正しい方向で取り付けてください（例えば[この記事など](https://zenn.dev/digitarhythm/articles/276cd44a36ed32)）。以下の写真では左右が間違ってそうです...

|                            |                             |                             |                             |
| -------------------------- | --------------------------- | --------------------------- | --------------------------- |
| ![](./img/4_1_rp-zero.jpg) | ![](./img/4_1_rp-zero2.jpg) | ![](./img/4_1_rp-zero3.jpg) | ![](./img/4_1_rp-zero4.jpg) |

### 3. ファームウェアの書き込み

RP2040-zero に QMK ファームウェアを書き込みます。

1. このレポジトリの [Github action](https://github.com/cormoran/dya-keyboard/actions/workflows/main.yml) の最新のビルドから Artifacts `dya_qmk_latest` をダウンロードして解凍します。
2. PR2040-zero を PC に接続します
3. Boot スイッチと Reset スイッチを同時に押して、Reset スイッチ → Boot スイッチの順で離します。PRI-PR2 という名前で USB メモリのようにデバイスが PC と接続されます。
4. 1 で解答したディレクトリに含まれるファームウェアファイルを USB メモリに移動させる要領で PRI-PR2 にコピーします。

- `via.uf2` は VIA/Remap 対応のファームウェアです。デフォルトは US 配列ですが、[VIA](https://www.usevia.app/) or [Remap](https://remap-keys.app/) でノーコードでキー配列を変更できます。
  VIA, Remap で必要な json ファイルは [/farms/qmk/keybaords/dya/dyya-via.json](https://github.com/cormoran/dya-keyboard/blob/main/farms/qmk/keyboards/dya/dya-via.json) に置いています。
- `dya_us.uf2`, `dya_jis.uf2` は VIA 未対応の US, JIS 配列ファームウェアです。

### 4. 動作確認と組み立て

右側のキーボードから組み立てます。

1.  回路基板にコンスルーを取り付けた RP2040-zero を差し込みます。抜き差しの際に斜めになるとコンスルーが曲がるので注意して上からまっすぐ抜き差ししてください。

2.  RP2040-zero の USB ポートを PC と接続します。接続が問題なければキーボード側基板に搭載した LED が点灯します。点灯しない場合は PC が RP2040-zero を認識しているか、コンスルーの接続に不良がないかを確かめてください。動作確認ができたら RP2040-zero から USB ケーブルを取り外してください。

|                            |                             |
| -------------------------- | --------------------------- |
| ![](./img/5_1_rp-zero.jpg) | ![](./img/5_1_rp-zero2.jpg) |

3. スタビライザーの取り付け

基板にスタビライザーを取り付けます。

US 配列の場合は以下のように２箇所、JIS 配列の場合は enter key 用に１箇所取り付けてください。
スタビライザーにルブをする場合はこのタイミングか、 6 のケース組み立て前のタイミングでしてください。

|                                  |                                   |
| -------------------------------- | --------------------------------- |
| ![](./img/6_0_stabilizer_us.jpg) | ![](./img/6_0_stabilizer_jis.jpg) |

4. トラックボール基板を FFC ケーブルで接続します。

FFC ケーブルは乱雑に扱うと断線します。丁寧に扱ってください。

- まずキーボード基板（右）に FFC ケーブルを接続します。
- 写真のソケットの黒い部分を垂直に立ててロックを解除します
- FFC ケーブルの青い部分が表側に来るように差し込んで、黒い部分を倒してロックケーブルをロックします
- 同様にトラックボール基板に FFC ケーブルを接続してください。FFC ケーブルの面裏に注意してください。

- トラックボール基板をトラックボールケースに差し込みます。奥まで差し込んでください。
- トラックボールケースをボトムケース（右）に写真のようにはめ込みます。
- FFC ケーブルをいい感じに配線しつつキーボード基板をケースにはめ込みます。
  - この時に FFC ケーブルをテープでボトムケースに固定してください。
  - FFC ケーブルは軽く折り目をつけて曲げて、キーボード基板を押し込んだ際に FFC ケーブルが縦に潰されないように配線してください。
  - トラックボールケースの位置調整ができるように、FFC はトラックボール側に十分なゆとりを持たせるように固定してください。ケーブルが張った状態だと位置調整時や使用中にケーブルが外れる可能性があります。

基板取り付け時に PR2040-zero とボトムケースの間に適当な詰め物をしておくと良いかもしれません。
作者は静音性向上によく使われるポロンシート(5mm)を詰めることで使用中にコンスルーが外れる可能性を軽減しています。

|                        |                              |                                   |                         |                    |                         |
| ---------------------- | ---------------------------- | --------------------------------- | ----------------------- | ------------------ | ----------------------- |
| ![](./img/6_1_ffc.jpg) | ![](./img/6_2_trackball.jpg) | ![](./img/6_3_trackball-case.jpg) | ![](./img/6_4_case.jpg) | ![](./img/6_6.jpg) | ![](./img/6_7_case.jpg) |

5.  トラックボールの動作確認をします。

- RP2040-zero の USB ポートを PC と接続してください。
- トラックボールケースに 34mm トラックボールをセットして、PC のポインターが動作するか確認してください。

6. トッププレートを組み立てます

- トッププレートとトップケースを用意してください。
- 以下の写真のように、親指部分でトッププレートをケースの下に差し込みながら、ケースの上からトッププレートを差し込みます。
- トップケースをボトムケースにはめ込みます

|                        |                        |                        |
| ---------------------- | ---------------------- | ---------------------- |
| ![](./img/7_1_top.jpg) | ![](./img/7_2_top.jpg) | ![](./img/7_3_top.jpg) |

7. スイッチの取り付け

**スイッチの形状によって RP2040-zero のコンスルーに干渉する場合があります。干渉する場合はスイッチの干渉する部分をニッパー等で切り取ってください。** LED 部分に大きめの穴が空いたスイッチは干渉しないようです。

- スイッチのピンと基板の穴の方向に注意していくつかスイッチを取り付けます
  - スイッチの種類によっては取り付けに少し力が必要なことがあります
  - スイッチのピンが曲がっている場合、基板のソケットが破損したりスイッチが破損したりする場合があるので注意しながら差し込んでください。取り付けづらい場合は一度回路基板を取り外して裏側から支えながらスイッチをセットすると安全です。
- いくつかつけたらもう一度動作確認をします。ケースの外側の USB ソケットと PC を接続して、スイッチを押してみてください。PC 側で反応があれば動作確認成功です。
- 全てのスイッチを取り付けます

|                           |                         |                    |
| ------------------------- | ----------------------- | ------------------ |
| ![](./img/8_1_switch.jpg) | ![](./img/8_2_test.jpg) | ![](./img/8_3.jpg) |

8. ねじ止め

パーツをねじ止めします。**ねじを強く締めすぎないように注意してください。** 3DP プリンタ製のパーツは強度が不十分なため簡単にネジ穴が潰れてしまいます。

- まずトラックボールケースを固定します。裏側から見ると２箇所ネジ穴があるので短いネジで止めてください。
- 次にトッププレートとボトムプレートを固定します。１０個ネジ穴がありますが、以下で示している４つを止めるだけで十分です。他の部分はお好みに合わせて固定してください。

![](./img/8_4.jpg)
![](./img/8_5.jpg)

9. ゴム足の取り付け

ゴム足をケース裏側のへこみ部分４箇所に取り付けます

10. キーキャップの取り付け

キーキャップを取り付けて完成です。

![](./img/8_6.jpg)

11. 左側の組み立て

右側同様に組み立ててください。FFC ケーブルでの接続がない分簡単です。
左側組み立て時にも右側でやったのと同様に USB 接続をすることで動作確認をすることができます。

12. 左右を接続して動作確認

- 左右の内側の USB ポートどうし（上寄りのポートどうし）を接続します
- 右の外側の USB ポートを PC と接続します

完成！

![](./img/goal.jpg)
